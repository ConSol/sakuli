
:imagesdir: ../../../images

==== OMD Screenshot History

[#git-edit-section]
:page-path: docs/manual/integration/monitoring/advanced-topics/omd-screenshot-history.adoc
git-link:{page-path}{git-view} | git-link:{page-path}{git-edit}


Since Sakuli `v1.1.0`, exception messages containing a screenshot also provide a CSS based magnifier/lightbox option to enlarge the currently displayed image. This perfect if you can live with the fact that a screenshot is only visible for the time until the next result arrives - which will update the service output and the embedded image.

It is also possible to view a screenshot history. (This has been tested in OMD; for other monitoring systems you might have to adapt the SSI.)

Each Sakuli check is combined with an event handler script, which saves the base64 encoded image to the local file system if the result is CRITICAL and the output contains the pattern "EXCEPTION". The monitoring web frontend (in OMD: Thruk) then can load these images into a lightbox. 

.configure event handler (OMD system)

Copy the event handler script to the local plugin directory

[source]
----
OMD[sakuli]:~$ cp __TEMP__/sakuli-vx.x.x-SNAPSHOT/setup/nagios/screenshot_lightbox/eh_sakuli_screenshot.sh ~/local/lib/nagios/plugins/
----

and define a command: 

[source]
----
vim ~/etc/nagios/conf.d/commands.cfg

define command {
    command_name                   eh_sakuli_screenshot
    command_line                   $USER2$/eh_sakuli_screenshot.sh $SERVICESTATE$ $HOSTNAME$ $SERVICEDESC$ $LASTSERVICECHECK$
}  
----

The eventhandler script also deletes screenshots older than 30 days. If you want to overwrite this, define the number of days to keep screenshots as a custom macro (e.g. `$USER12$`) and use this variable as fifth parameter: 

[source]
----
    command_line                   $USER2$/eh_sakuli_screenshot.sh $SERVICESTATE$ $HOSTNAME$ $SERVICEDESC$ $LASTSERVICECHECK$ $USER12$
----

Now connect the event handler command to every Sakuli service: 

[source]
----
define service {
    service_description            sakuli_ubuntu
    host_name                      sakuli_client
    use                            generic-service,srv-pnp
    ...
    ...
    event_handler                  eh_sakuli_screenshot
}
----

Reload the monitoring core. 

.screenshot directory

Create the screenshot directory: 

[source]
----
OMD[sakuli]:~$ mkdir -p ${OMD_ROOT}/var/sakuli/screenshots
----

Install the Apache configuration file: 

[source]
----
OMD[sakuli]:~$ cp __TEMP__/sakuli-vx.x.x-SNAPSHOT/setup/nagios/screenshot_lightbox/sakuli_screenshots.conf ~/etc/apache/conf.d/sakuli_screenshots.conf
----

.Thruk SSI

SSI (Server Side Include) is a technique to include additional code delivered by the web server. You have to extend Thruks SSI files with some HTML/CSS/JS, to make the lightbox working. Upcoming versions of Thruk will support custom SSI files, too (https://github.com/sni/Thruk/commit/1183f28071855a76d43ec49bd60aaba316d7fcb0[commit]).

Open `__TEMP__/sakuli-vx.x.x-SNAPSHOT/setup/nagios/screenshot_lightbox/extinfo-header.ssi.add` and follow the instructions how to add the JavaScript/CSS/HTML to `extinfo-header.ssi`.

From now, clicking on a screenshot opens the lightbox which shows the last event. Use the buttons on the bottom right corner or the arrow keys to browse through all previous events; press Esc to close the lightbox again: 

image:screenshot-history.png[screenshot history]

