
:imagesdir: ../../../images

[[openshift]]
==== OpenShift
[#git-edit-section]
:page-path: docs/manual/execution/containerized/openshift.adoc
git-link:{page-path}{git-view} | git-link:{page-path}{git-edit}

Following we will describe, how to use link:https://www.openshift.com/[OpenShift] for Sakuli E2E testing and monitoring. The following content uses as example the image `consol/sakuli-ubuntu-xfce` of the Dockerfile `git-link:docker/Dockerfile.sakuli.ubuntu.xfce[link-text="Dockerfile.sakuli.ubuntu.xfce", mode="view", link-window="_blank"]`.

First you have to create your OpenShift project, user your command line:

[source]
----
cd openshift                
oc new-project my-project   
----

Then you can use the provided templates as follows:

[[openshift-run-image]]
===== Run Image from Dockerhub

[source]
----
cd openshift                
oc new-project my-project   
----

As soon as you are logged in and have selected your oc project, you can simply run the image by using the configuration `git-link:docker/openshift/openshift.sakuli.example.pod.run.yaml[link-text="openshift.sakuli.example.pod.run.yaml", mode="view", link-window="_blank"]`:

[source]
----
oc process -f openshift.sakuli.example.pod.run.yaml -v E2E_TEST_NAME=single-pod | oc create -f -
----

After the deployment you will see at your management UI the new deployed service:

[source]
----
https://__YOUR-OS-MANAGEMENT-URL__/console/project/my-project/overview`
----

image:os_run_only.png[openshift management consol run-only service]

Over the URL you can look and control the fresh deployed container via the web-vnc interface:

[source]
----
http://my-run-only-pod-my-project.__YOUR-OS-URL__/?password=sakuli`
----

image:os_container_webvnc.png[openshift container via webvnc]

If you want to use another Sakuli Image just use the `IMAGE` var:

[source]
----
oc process -f openshift.sakuli.example.pod.run.yaml -v E2E_TEST_NAME=single-pod -v IMAGE=consol/sakuli-ubuntu-icewm | oc create -f -
----

===== Build &amp; Run your own Image

If you want to build the image in your own infrastructure just use the configuration `git-link:docker/openshift/openshift.sakuli.example.image.build.yaml[link-text="openshift.sakuli.example.image.build.yaml", mode="view", link-window="_blank"]`:

[source]
----
oc process -f openshift.sakuli.example.image.build.yaml -v IMAGE=sakuli-oc-image | oc create -f -
----

Or if you wan't to build a custom Dockerfile in a specific branch:

[source]
----
oc process -f openshift.sakuli.example.image.build.yaml \
    -v IMAGE=sakuli-oc-image-icewm \
    -v SOURCE_REPOSITORY_REF=dev \
    -v SOURCE_DOCKERFILE=Dockerfile.sakuli.ubuntu.icewm \
    | oc create -f -
----

====== Use images from oc docker registry

To use an already builded image from the internal OpenShift registry you have to specify the image in the pattern `<registry-ip>/<your-project>/<image-name>[:<tag>]`:

[source]
----
oc process -f openshift.sakuli.example.pod.run.yaml -v IMAGE=10.0.0.X:5000/my-project/sakuli-oc-image,E2E_TEST_NAME=oc-image-test-2 | oc create -f -
----

===== Run git based Tests

====== Git based test definitions through volume mounts

An effective way to execute your own Sakuli Tests is, that you mount the testsuite into the container. Therefore you can use the template `openshift.sakuli.gitvolume.pod.run.yaml`. The template will checkout the git repository and mount it as read-only volume into the container, where Sakuli will execute it:

[source]
----
oc process -f openshift.sakuli.gitvolume.pod.run.yaml \
    -v GIT_TEST_SUITE_REPO=https://github.com/ConSol/sakuli-examples \
    -v GIT_TEST_SUITE_PATH=docker-xfce/part_01/example_xfce \
    | oc create -f -
----

If something went wrong, you maybe have to enable this volume type in the cluster:

====== Configure use of gitRepo volumes:

Login as administrator:

[source]
----
oc login -u system:admin
----

Edit the security :

[source]
----
oc edit securitycontextconstraints/restricted
----

add `gitRepo` to `volumes`:

[source]
----
volumes:
- configMap
- downwardAPI
- emptyDir
- persistentVolumeClaim
- secret
- gitRepo
----

===== Other useful commands

====== Delete specific application or E2E test

[source]
----
oc process -f openshift.sakuli.example.pod.run.yaml -v E2E_TEST_NAME=single-job | oc delete --grace-period=5 -f -
----

====== Delete all running pods and configs

[source]
----
oc delete dc --all && oc delete routes --all && oc delete pods --all && oc delete services --all && oc delete jobs --all
----